// Prisma Schema for Open Pet Platform
// Azure PostgreSQL Flexible Server

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// NEXTAUTH.JS AUTHENTICATION
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// USER & PREFERENCES
// ==========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("user") // "user", "admin", "shelter"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth Relations
  accounts      Account[]
  sessions      Session[]

  // App Relations
  preferences   UserPreference?
  swipeHistory  SwipeHistory[]

  @@index([email])
}

model UserPreference {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Preference weights (JSON for flexibility)
  tagWeights    Json     @default("{}")  // e.g., {"High Energy": 5, "Cat": -2}
  breedWeights  Json     @default("{}")  // e.g., {"Labrador": 3}
  sizeWeights   Json     @default("{}")  // e.g., {"Small": 2}
  energyWeights Json     @default("{}")  // e.g., {"High": 3}

  // Explicit preferences from wizard
  preferredSpecies   String?  // "Dog", "Cat", or null for both
  preferredSize      String?  // "Small", "Medium", "Large"
  preferredEnergy    String?  // "Low", "Moderate", "High"
  goodWithKids       Boolean?
  goodWithDogs       Boolean?
  goodWithCats       Boolean?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SwipeHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  petId     String   // External pet ID from adapter
  action    String   // "like", "nope", "superlike"
  
  createdAt DateTime @default(now())

  @@unique([userId, petId])
  @@index([userId])
  @@index([petId])
}

// ==========================================
// AI CACHING (Cost Optimization)
// ==========================================

model AICache {
  id        String   @id @default(cuid())
  
  // Cache key = hash of input parameters
  cacheKey  String   @unique
  cacheType String   // "bio", "embedding", "recommendation", "chat"
  
  // Cached response (JSON for flexibility)
  response  Json
  
  // Token usage tracking for cost monitoring
  tokensUsed Int     @default(0)
  model      String? // "gpt-3.5-turbo", "gpt-4", "text-embedding-3-small"
  
  // TTL management
  createdAt DateTime @default(now())
  expiresAt DateTime?

  @@index([cacheKey])
  @@index([cacheType])
  @@index([expiresAt])
}

// ==========================================
// PET EMBEDDINGS (Semantic Search)
// ==========================================

model PetEmbedding {
  id        String   @id @default(cuid())
  
  petId     String   @unique // External pet ID from adapter
  source    String   // "petfinder", "shelterluv", "mock"
  
  // The embedding vector (stored as JSON array of floats)
  // text-embedding-3-small produces 1536 dimensions
  embedding Json
  
  // Hash of pet data used to generate embedding
  // If pet data changes, we regenerate
  contentHash String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([petId])
  @@index([source])
}

// ==========================================
// AI PET CONTENT (Generated Descriptions & Labels)
// ==========================================

model AIPetContent {
  id              String   @id @default(cuid())
  
  petId           String   @unique  // External pet ID from adapter
  source          String             // "petfinder", "shelterluv", "buffalo", "mock"
  
  // Content hash for smart regeneration
  // Hash of {breed, age, description, imageUrl} - regenerate if changed
  contentHash     String
  
  // Enrichment tier completed
  // "heuristic" = Tier 0 only (free), "basic" = Tier 0+1, "full" = all tiers including AI
  enrichmentTier  String   @default("heuristic")
  
  // Tier 0: Heuristic-based (always populated, FREE)
  heuristicTags   Json     @default("[]")  // Array of strings from text-analysis.ts
  energyLevel     String?                   // "Low", "Moderate", "High"
  size            String?                   // "Small", "Medium", "Large", "Extra Large"
  ageCategory     String?                   // "Baby", "Young", "Adult", "Senior"
  
  // Tier 2: AI-generated (optional, COSTS TOKENS)
  aiBio           String?  @db.Text         // Gemini-generated adoption bio
  aiSummary       String?                   // 1-line summary for cards
  aiTags          Json     @default("[]")   // AI-inferred personality tags
  aiTemperament   Json     @default("[]")   // AI-detected temperament
  
  // Image analysis results (optional, expensive - only when needed)
  imageAnalysis   Json?    // {breed, color, temperament, description}
  imageAnalyzed   Boolean  @default(false)
  
  // Tracking
  tokensUsed      Int      @default(0)      // Total tokens spent on this pet
  modelVersion    String?                   // "gemini-1.5-flash" for cache invalidation
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([petId])
  @@index([source])
  @@index([contentHash])  // For deduplication lookup
  @@index([enrichmentTier])
}

// ==========================================
// USAGE TRACKING (Budget Control)
// ==========================================

model AIUsage {
  id        String   @id @default(cuid())
  
  date      DateTime @db.Date @default(now())
  model     String   // "gemini-1.5-flash", "gemini-1.5-pro", "text-embedding-004"
  
  // Daily totals
  requestCount Int   @default(0)
  tokensUsed   Int   @default(0)
  estimatedCost Float @default(0)

  @@unique([date, model])
  @@index([date])
}
